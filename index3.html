<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>智能 QR 掃描器</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
   html, body {
     margin: 0;
     padding: 0;
     font-family: sans-serif;
     background: #000;
     color: white;
     height: 100vh;
     overflow: hidden;
   }
   header {
     text-align: center;
     padding: 15px;
     font-size: 20px;
     background-color: #222;
     color: #fff;
   }
   #reader {
     width: 100%;
     height: calc(100vh - 60px); /* 扣除 header 高度 */
     display: flex;
     justify-content: center;
     align-items: center;
   }
   #reader > div {
     width: 90vw;
     max-width: 500px;
     aspect-ratio: 1 / 1;
   }
</style>
</head>
<body>
<header>放學接送打打氣</header>
<div id="reader"></div>
<script>
   let html5QrCode;
   let isRunning = false;
   function isIpad() {
     const ua = navigator.userAgent.toLowerCase();
     return /ipad/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
   }
   function isMobile() {
     return /iphone|android|mobile/i.test(navigator.userAgent);
   }
   function getCameraFacingMode() {
     if (isIpad()) return "user";
     if (isMobile()) return "environment";
     return "user";
   }
   function getBoxSize() {
     const minSide = Math.min(window.innerWidth, window.innerHeight - 60); // 扣 header
     const boxSize = Math.floor(minSide * 0.85);
     return Math.min(boxSize, 500);
   }
   function startScanner() {
     const facingMode = getCameraFacingMode();
     const qrboxSize = getBoxSize();
     if (isRunning) {
       html5QrCode.stop().then(() => {
         startHtml5QrCode(facingMode, qrboxSize);
       });
     } else {
       startHtml5QrCode(facingMode, qrboxSize);
     }
   }
   function startHtml5QrCode(facingMode, qrboxSize) {
     html5QrCode = new Html5Qrcode("reader");
     html5QrCode.start(
       { facingMode: facingMode },
       {
         fps: 10,
         qrbox: {
           width: qrboxSize,
           height: qrboxSize
         }
       },
       onScanSuccess,
       onScanError
     ).then(() => {
       isRunning = true;
     }).catch(err => console.error("啟動失敗:", err));
   }
   function onScanSuccess(qrCodeMessage) {
     const encodedData = encodeURIComponent(qrCodeMessage.trim());
     html5QrCode.stop().then(() => {
       window.location.href = `result.html?data=${encodedData}`;
     });
   }
   function onScanError(errorMessage) {
     // 可以忽略錯誤
   }
   startScanner();
   window.addEventListener("resize", () => {
     clearTimeout(window.resizeTimeout);
     window.resizeTimeout = setTimeout(() => {
       startScanner();
     }, 300);
   });
</script>
</body>
</html>
